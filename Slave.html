<!DOCTYPE html>
<meta charset="utf-8">
<title>Caption (Slave)</title>
<link rel="stylesheet" type="text/css" href="Boventiteling.css">
<body>
	<script src="d3.js"></script>
	<div id="Nederlands" class="upper">
		<h1 id="HeaderNederlands" class="subtitle">
			Nederlands
		</h1>
	</div>
	<hr id="separator" class="symbol"/>
	<div id="Frans" class="lower">
		<h1 id="HeaderFrans" class="subtitle">
			Fran√ßais
		</h1>
	</div>
	
	<script>
		window.WebSocket = window.WebSocket || window.MozWebSocket;

		var connection = new WebSocket('ws://localhost:1337');
	</script>

	<script>
		var nederlandsTitel = d3.select("#Nederlands").selectAll("h1");
		var fransTitel = d3.select("#Frans").selectAll("h1");

		var id;

		var subtitleInfo = {nl: "", fr: "", size: 72, mode: "dual"};

		connection.onmessage = function (message){
			var json;

			console.log('received: ' + message.data);

			try{
				json = JSON.parse(message.data);
			}catch (e) {
				console.log(message.data);
            	return;
        	}

        	if(json.type == 'id'){
        		id = json.id;
        	}

        	if(json.type == 'subtitle'){
        		subtitleInfo.nl = json.nl;
        		subtitleInfo.fr = json.fr;
        		showSubtitle(json.nl, json.fr);
        	}
        	
        	if(json.type == 'size'){
        		subtitleInfo.size = json.size;
        		console.log('I resize: ' + json.size);
        		setSize(json.size);
        	}

        	if(json.type == 'mode'){
        		console.log(json.peer + " == " + id + "?");
        		if(json.peer == id){
        			subtitleInfo.mode = json.mode;
        			setVisibility(json.mode);
        		}
        	}

        	if(json.type == 'identify'){
        		identify();
        	}
		};

		function identify(){
			setVisibility("dual");
			showSubtitle(id,id);
			setTimeout(showSubtitle, 500, subtitleInfo.nl, subtitleInfo.fr);
			setTimeout(setVisibility, 500, subtitleInfo.mode);
		};

		function setSize(size){
			nederlandsTitel.style("font-size", size + "px");
			fransTitel.style("font-size", size + "px");
		}

		function showSubtitle(nl, fr) {
			nederlands = nederlandsTitel.data([nl]);
			frans = fransTitel.data([fr]);

			var returnText = function (d){
				return d;
			}

			nederlands.text(returnText);
			frans.text(returnText);
		};

		function setVisibility(mode){
			if(mode == "nl"){
				d3.select("#separator").style("visibility", "collapse");
				d3.select("#Frans").style("visibility", "collapse");
			}
			if(mode == "fr"){
				d3.select("#separator").style("visibility", "collapse");
				d3.select("#Nederlands").style("visibility", "collapse");
			}
			if(mode == "dual"){
				d3.select("#separator").style("visibility", "visible");
				d3.select("#Nederlands").style("visibility", "visible");
				d3.select("#Frans").style("visibility", "visible");
			}
		};
	</script>